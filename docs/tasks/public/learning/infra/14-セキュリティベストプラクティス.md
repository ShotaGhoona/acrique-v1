# セキュリティベストプラクティス

ACRIQUEを安全に運用するために知っておくべきこと。

---

## 1. 最も重要な3つ

```mermaid
graph TD
    A[セキュリティ三原則]
    A --> B[1. 最小権限]
    A --> C[2. 秘密情報の管理]
    A --> D[3. ネットワーク分離]
```

---

## 2. IAM: 最小権限の原則

### やってはいけないこと

```typescript
// ❌ 何でもできる権限
policy: iam.ManagedPolicy.fromAwsManagedPolicyName('AdministratorAccess')

// ❌ すべてのリソースに対して全アクション許可
{
  Effect: 'Allow',
  Action: '*',
  Resource: '*'
}
```

### 正しいやり方

```typescript
// ✅ 必要な権限だけ
{
  Effect: 'Allow',
  Action: ['s3:GetObject', 's3:PutObject'],
  Resource: 'arn:aws:s3:::my-bucket/*'
}
```

### ACRIQUEでの実践

```
ECSタスク → S3へのアクセス権限のみ
Lambda → DynamoDBへの読み書き権限のみ
CI/CD → ECRへのpush権限 + ECSのデプロイ権限のみ
```

---

## 3. 秘密情報の管理

### やってはいけないこと

```typescript
// ❌ コードに直書き
const dbPassword = 'super-secret-password123';

// ❌ 環境変数ファイルをGitにコミット
// .env
DATABASE_URL=postgresql://user:password@host:5432/db
```

### 正しいやり方

```mermaid
graph LR
    subgraph "正しい流れ"
        SM[Secrets Manager] -->|実行時に取得| ECS[ECS]
        ECS -->|接続| RDS[(RDS)]
    end
```

### ACRIQUEでの実装

```typescript
// CDKでSecrets Managerを使う
secrets: {
  DATABASE_URL: ecs.Secret.fromSecretsManager(dbSecret),
}

// ECSはSecrets Managerから取得した値を環境変数として使用
```

### .gitignore に必ず入れるもの

```gitignore
.env
.env.local
*.pem
*credentials*
```

---

## 4. ネットワーク分離

### ACRIQUEの構成

```mermaid
graph TB
    Internet[インターネット]

    subgraph "Public Subnet"
        ALB[ALB<br/>ここだけ外部公開]
    end

    subgraph "Private Subnet"
        ECS[ECS<br/>外部から直接アクセス不可]
        RDS[(RDS<br/>外部から直接アクセス不可)]
    end

    Internet -->|HTTPS| ALB
    ALB -->|内部通信| ECS
    ECS -->|内部通信| RDS
    Internet -.->|❌ 拒否| ECS
    Internet -.->|❌ 拒否| RDS
```

### Security Group の設計

```
SG-ALB:
  インバウンド: 443 from 0.0.0.0/0（誰でもHTTPS可）

SG-ECS:
  インバウンド: 8000 from SG-ALB（ALBからのみ）

SG-RDS:
  インバウンド: 5432 from SG-ECS（ECSからのみ）
```

**ポイント:** IPアドレスではなく、Security Groupで許可する

---

## 5. HTTPS化

### なぜ必要？

```
HTTP: 通信が平文 → 盗聴される
HTTPS: 通信が暗号化 → 安全
```

### ACRIQUEでの対応

```
Amplify: 自動でHTTPS
ALB: Certificate Manager で証明書発行 → ALBにアタッチ
```

---

## 6. WAF（Web Application Firewall）

### 何を防ぐ？

| 攻撃 | WAFで防御 |
|-----|---------|
| SQLインジェクション | ✅ |
| XSS | ✅ |
| DDoS | ✅（レート制限） |
| 既知の悪意あるIP | ✅ |

### ACRIQUEでの設定

```typescript
// config/prod.ts
waf: {
  enabled: true,
  rateLimit: 2000,  // 5分間2000リクエストまで
}
```

**本番環境では必須。開発環境はコスト削減で無効でOK。**

---

## 7. 監査ログ

### CloudTrail

```
誰が、いつ、何をしたか記録

例:
- 山田さんが RDS を削除した
- 田中さんが IAM ロールを変更した
```

### 有効化

```typescript
new cloudtrail.Trail(this, 'Trail', {
  bucket: logBucket,
  includeGlobalServiceEvents: true,
});
```

---

## 8. 定期的にやるべきこと

### チェックリスト

```
□ 未使用のIAMユーザー・ロールを削除
□ アクセスキーをローテーション（90日ごと）
□ Security Groupのルールを見直し
□ パッチ適用（RDS, ECS のベースイメージ）
□ CloudTrail ログの確認
□ 課金アラートの確認
```

---

## まとめ

```
1. 最小権限: 必要な権限だけ付与
2. 秘密情報: Secrets Manager で管理
3. ネットワーク: Private Subnet に隠す
4. 通信: HTTPS 必須
5. 防御: WAF を有効化（本番）
6. 監査: CloudTrail でログ記録
```

---

**作成日**: 2025-01-06
**レベル**: 中級
