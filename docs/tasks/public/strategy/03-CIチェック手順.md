# CIチェック手順書

## 概要

コードをプッシュする前に、CIが通ることを確認するための手順をまとめる。
静的解析ツール（ruff等）だけでは検出できないエラーを事前に防ぐ。

---

## 背景（なぜこの手順が必要か）

静的解析ツールには限界がある:

| ツール | 検出できる | 検出できない |
|--------|-----------|-------------|
| `ruff check` | 構文エラー、スタイル違反、未使用変数 | **インポートエラー（存在しないモジュール）** |
| `ruff format` | フォーマット不整合 | 実行時エラー全般 |
| `npm run build` | TypeScript型エラー、ESLintエラー | - |

**実例:** `OrderItemInputDTO` という存在しないクラスをインポートしても、ruffは「構文的に正しい」と判断して通過する。

---

## 前提条件

- Docker環境が構築済み
- `docker compose up -d` でコンテナが起動している

---

## チェック手順

### 1. バックエンド - Linting & Formatting

```bash
docker exec acrique-v1-backend-1 ruff check .
docker exec acrique-v1-backend-1 ruff format --check .
```

**期待する結果:**
- `All checks passed!`
- `XX files already formatted`

---

### 2. バックエンド - インポート検証（重要）

```bash
docker exec acrique-v1-backend-1 python -c "from app.main import app; print('Import OK')"
```

**期待する結果:**
```
Import OK
```

**よくあるエラーと対処:**

| エラー | 原因 | 対処 |
|--------|------|------|
| `ImportError: cannot import name 'XXX'` | 存在しないクラス/関数をインポート | 正しい名前に修正 |
| `ModuleNotFoundError: No module named 'xxx'` | モジュールが存在しない | requirements.txtに追加 |
| `SyntaxError` | 構文エラー | コードを修正 |

---

### 3. フロントエンド - ビルド

```bash
cd frontend && npm run build
```

**期待する結果:**
- Exit code 0（成功）
- Warningは許容、Errorは不可

**確認方法:**
```bash
npm run build > /dev/null 2>&1 && echo "SUCCESS" || echo "FAILED"
```

---

### 4. フロントエンド - Lint

```bash
cd frontend && npm run lint
```

---

## 一括チェックコマンド

すべてのチェックを順番に実行:

```bash
# バックエンド
docker exec acrique-v1-backend-1 ruff check . && \
docker exec acrique-v1-backend-1 ruff format --check . && \
docker exec acrique-v1-backend-1 python -c "from app.main import app" && \
echo "✅ Backend OK"

# フロントエンド
cd frontend && npm run build > /dev/null 2>&1 && echo "✅ Frontend OK"
```

---

## CIで実行されるチェック一覧

GitHub Actionsで実行される項目:

| ジョブ名 | 内容 | ローカル確認コマンド |
|---------|------|---------------------|
| Ruff Linting & Formatting | ruff check/format | `docker exec ... ruff check .` |
| Onion Architecture Validation | レイヤー依存チェック | - |
| Docker Build & Smoke Test | コンテナ起動テスト | `python -c "from app.main import app"` |
| Backend Tests | pytest実行 | `docker exec ... pytest` |
| Frontend test | npm run build | `npm run build` |

---

## チェックリスト

プッシュ前に確認:

- [ ] `ruff check .` が通る
- [ ] `ruff format --check .` が通る
- [ ] **`python -c "from app.main import app"` が通る** ← 忘れがち
- [ ] `npm run build` が通る（フロントエンド変更時）

---

## PRのCI状態確認

```bash
# PR番号を指定してCI状態を確認
gh pr checks <PR番号>

# 失敗したジョブのログを確認
gh run view <run_id> --log-failed
```

---

## トラブルシューティング

### ruffは通るのにDockerビルドが失敗する

→ **インポート検証を忘れている可能性が高い**

```bash
# これを必ず実行
docker exec acrique-v1-backend-1 python -c "from app.main import app"
```

### 特定のモジュールだけ検証したい

```bash
# 例: order_usecaseのみ
docker exec acrique-v1-backend-1 python -c "from app.application.use_cases.order_usecase import OrderUsecase"
```

### CIの結果をローカルで確認

```bash
gh pr checks <PR番号>
```

---

## 補足

- 静的解析ツールを過信しない
- 「ruffが通った = CIが通る」ではない
- リファクタリング後は特にインポート検証を忘れずに
