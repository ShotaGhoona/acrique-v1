# 検索機能 要件定義書

## 概要

ECサイトのヘッダーに配置する検索機能の要件定義。ユーザーが商品を効率的に検索できるよう、複数のフィールドを横断検索し、関連度の高い順に結果を表示する。

---

## 1. 検索対象

### 1.1 検索対象フィールド（優先順位順）

| 優先度 | フィールド | テーブル | 説明 |
|--------|----------|---------|------|
| 1 | `name` | products | 商品名（英語） |
| 1 | `name_ja` | products | 商品名（日本語） |
| 2 | `tagline` | products | タグライン/キャッチコピー |
| 3 | `description` | products | 短い説明文 |
| 3 | `long_description` | products | 詳細説明文 |
| 4 | `search_keywords` | products | 検索用キーワード（新規追加）※ |
| 5 | `name` | categories | カテゴリ名 |
| 6 | `value` | product_specs | 商品スペック値（サイズなど） |

※ `search_keywords` は新規追加フィールド。商品名や説明文に含まれない関連語を登録可能にする。

### 1.2 検索対象外

以下のテーブル・フィールドは検索対象外とする：

- `users` - ユーザー情報（プライバシー保護）
- `orders` - 注文情報（セキュリティ）
- `admins` - 管理者情報（セキュリティ）
- `cart_items` - カート情報
- `uploads` - 入稿データ（セキュリティ）

---

## 2. データベース設計

### 2.1 productsテーブルへの追加フィールド

```sql
-- 検索用キーワードフィールド（推奨）
ALTER TABLE products ADD COLUMN search_keywords TEXT;

-- 説明
-- カンマ区切りで複数のキーワードを登録可能
-- 例: "什器, ディスプレイ, 看板, 店舗用品, サロン"
-- 商品名や説明文に含まれない関連語を登録することで、検索精度を向上
```

### 2.2 検索用インデックス

```sql
-- 検索対象カラムにインデックスを作成（パフォーマンス向上）
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_name_ja ON products(name_ja);
CREATE INDEX idx_products_tagline ON products(tagline);
CREATE INDEX idx_products_description ON products(description);
CREATE INDEX idx_products_search_keywords ON products(search_keywords);

-- 全文検索用インデックス（PostgreSQLの場合、将来的な拡張用）
CREATE INDEX idx_products_search_fulltext ON products 
USING gin(to_tsvector('japanese', 
  coalesce(name_ja, '') || ' ' || 
  coalesce(description, '') || ' ' || 
  coalesce(search_keywords, '')
));
```

---

## 3. 検索ロジック

### 3.1 検索方法

- **部分一致検索**: `LIKE '%キーワード%'`
- **大文字小文字を区別しない**: `ilike` を使用
- **複数フィールドをOR検索**: いずれかのフィールドに一致すればヒット
- **最小検索文字数**: 1文字以上

### 3.2 関連度スコアリング

検索結果は関連度スコアでソートする：

| 条件 | スコア | 説明 |
|------|--------|------|
| 商品名に完全一致 | 100点 | `name_ja = 'キーワード'` |
| 商品名の先頭に一致 | 50点 | `name_ja LIKE 'キーワード%'` |
| 商品名に部分一致 | 30点 | `name_ja LIKE '%キーワード%'` |
| タグラインに一致 | 20点 | `tagline LIKE '%キーワード%'` |
| 検索用キーワードに一致 | 15点 | `search_keywords LIKE '%キーワード%'` |
| 説明文に一致 | 10点 | `description LIKE '%キーワード%'` |
| カテゴリ名に一致 | 5点 | `categories.name LIKE '%キーワード%'` |

**ソート順序:**
1. 関連度スコア（降順）
2. `sort_order`（昇順）
3. `created_at`（降順）

### 3.3 検索クエリ例

```sql
SELECT 
  p.*,
  CASE 
    WHEN p.name_ja = 'キーワード' THEN 100
    WHEN p.name_ja = 'キーワード' THEN 100
    WHEN p.name_ja LIKE 'キーワード%' THEN 50
    WHEN p.name_ja LIKE '%キーワード%' THEN 30
    WHEN p.tagline LIKE '%キーワード%' THEN 20
    WHEN p.search_keywords LIKE '%キーワード%' THEN 15
    WHEN p.description LIKE '%キーワード%' THEN 10
    WHEN c.name LIKE '%キーワード%' THEN 5
    ELSE 0
  END AS search_score
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
WHERE 
  p.is_active = true
  AND (
    p.name ILIKE '%キーワード%'
    OR p.name_ja ILIKE '%キーワード%'
    OR p.tagline ILIKE '%キーワード%'
    OR p.description ILIKE '%キーワード%'
    OR p.long_description ILIKE '%キーワード%'
    OR p.search_keywords ILIKE '%キーワード%'
    OR c.name ILIKE '%キーワード%'
  )
ORDER BY search_score DESC, p.sort_order ASC, p.created_at DESC
LIMIT 20 OFFSET 0;
```

---

## 4. 機能要件

### 4.1 基本検索機能（FR-1）

- ユーザーがキーワードを入力して商品を検索できる
- 複数のフィールドを横断検索（OR検索）
- 大文字小文字を区別しない検索
- 部分一致検索
- 最小検索文字数: 1文字以上

### 4.2 検索結果の表示（FR-2）

- 検索結果を一覧表示
- 検索結果件数の表示（例: "15件の商品が見つかりました"）
- 検索結果が0件の場合のメッセージ表示
  - "「キーワード」の検索結果が見つかりませんでした"
  - カテゴリ一覧へのリンクを表示

### 4.3 検索結果のソート（FR-3）

- 関連度順（デフォルト）
- 価格順（安い順/高い順）
- 新着順
- 人気順（将来的な拡張）

### 4.4 検索結果のフィルタ（FR-4）

- カテゴリで絞り込み（shop/office/you）
- 価格帯で絞り込み（将来的な拡張）
- その他の条件で絞り込み（将来的な拡張）

### 4.5 オートコンプリート（FR-5: オプション）

- 入力中に候補を表示（最大5-10件）
- 人気検索キーワードから提案
- 検索履歴から提案（将来的な拡張）

---

## 5. 非機能要件

### 5.1 パフォーマンス（NFR-1）

- **検索レスポンス時間**: 1秒以内
- **デバウンス処理**: 300-500ms（入力停止を待ってからAPI呼び出し）
- **検索結果のキャッシュ**: 2-5分（人気検索キーワードの結果をキャッシュ）
- **ページネーション**: 20-50件/ページ

### 5.2 セキュリティ（NFR-2）

- **SQLインジェクション対策**: パラメータ化クエリを使用
- **XSS対策**: 入力値のサニタイズ
- **レート制限**: 過度なリクエストを制限（1分間に10回までなど）

### 5.3 ユーザビリティ（NFR-3）

- **最小検索文字数**: 1-2文字
- **検索結果の最大表示件数**: 20-50件/ページ
- **ページネーション対応**
- **検索履歴の保存**（将来的な拡張）

---

## 6. UI/UX要件

### 6.1 ヘッダー検索窓

**パターンA: シンプルな検索ボタン（推奨）**
```
[検索アイコン] → クリック → 検索窓が展開/モーダル表示
```

**パターンB: 常時表示の検索バー**
```
[ロゴ] [カテゴリ] [検索窓___________] [カート] [ログイン]
```

### 6.2 検索結果の表示方法

**インライン検索（ドロップダウン）**
- 検索窓の下に結果を表示
- リアルタイム検索（入力と同時に更新）
- 最大5-10件をプレビュー表示
- 「すべて見る」リンクで検索結果ページへ

**検索結果ページ**
- `/search?q=キーワード`
- フィルタ機能（カテゴリ、価格帯など）
- ソート機能（関連度、価格、新着順）
- ページネーション

---

## 7. 管理画面要件

### 7.1 検索用キーワードの管理

商品編集画面に検索用キーワード入力欄を追加：

```
商品編集画面:
┌─────────────────────────────┐
│ 商品名: [QR Cube]           │
│ 説明文: [QRコードを...]      │
│                             │
│ 検索用キーワード:            │
│ [什器, ディスプレイ, 看板]  │
│ (カンマ区切りで複数入力可能) │
│                             │
│ 説明: 商品名や説明文に含まれ │
│ ない関連語を入力してください │
└─────────────────────────────┘
```

### 7.2 検索ログの分析（将来的な拡張）

- 人気検索キーワードの表示
- 検索結果が0件のキーワードの表示
- 検索キーワードのトレンド分析

---

## 8. API設計

### 8.1 エンドポイント

```
GET /api/products/search
```

### 8.2 リクエストパラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `keyword` | string | 必須 | 検索キーワード（最小1文字） |
| `category_id` | string | 任意 | カテゴリID（shop/office/you） |
| `limit` | integer | 任意 | 取得件数（デフォルト: 20、最大: 100） |
| `offset` | integer | 任意 | オフセット（デフォルト: 0） |
| `sort` | string | 任意 | ソート順（relevance/price_asc/price_desc/newest） |

### 8.3 レスポンス

```json
{
  "products": [
    {
      "id": "qr-cube",
      "name": "QR Cube",
      "name_ja": "QRキューブ",
      "tagline": "QRコードを表示するアクリルスタンド",
      "base_price": 5000,
      "main_image_url": "...",
      "search_score": 30
    }
  ],
  "total": 15,
  "keyword": "QR",
  "category_id": null,
  "limit": 20,
  "offset": 0
}
```

---

## 9. 実装優先度

### Phase 1: 基本検索（MVP）

- [ ] 商品名、説明文、タグラインで検索
- [ ] 基本的な検索結果表示
- [ ] 検索結果ページ（`/search?q=キーワード`）
- [ ] デバウンス処理
- [ ] インデックスの作成

### Phase 2: 検索精度向上

- [ ] 検索用キーワードフィールド追加（`search_keywords`）
- [ ] 関連度スコアリング実装
- [ ] ソート機能（関連度/価格/新着）
- [ ] フィルタ機能（カテゴリ）
- [ ] 管理画面での検索用キーワード入力欄

### Phase 3: 高度な機能

- [ ] オートコンプリート
- [ ] 検索履歴
- [ ] 全文検索（PostgreSQL全文検索）
- [ ] 検索ログの分析
- [ ] あいまい検索（Fuzzy Search）

---

## 10. 検索用キーワードの運用方針

### 10.1 キーワードの選定基準

1. **商品名や説明文に含まれない関連語**
   - 例: 商品名が "QR Cube" でも "什器" で検索可能にする

2. **ユーザーが使う可能性のある言葉**
   - 例: "ディスプレイ", "看板", "店舗用品", "サロン"

3. **同義語・類義語**
   - 例: "アクリル" = "アクリル板" = "アクリル製品"

4. **用途・シーン**
   - 例: "美容室", "飲食店", "オフィス", "ギフト"

### 10.2 キーワードの入力例

```
商品: QR Cube
検索用キーワード: "什器, ディスプレイ, 看板, 店舗用品, サロン, 美容室, QRコード, スタンド"

商品: 名入れプレート
検索用キーワード: "看板, サイン, プレート, 名札, オーダーメイド, カスタム, ギフト, 記念品"
```

---

## 11. 検索結果が0件の場合の対応

### 11.1 メッセージ表示

```
「キーワード」の検索結果が見つかりませんでした
```

### 11.2 代替案の提示

- カテゴリ一覧へのリンク
- 人気商品の表示
- 類似キーワードの提案（将来的な拡張）

---

## 12. 参考資料

- [要件定義: データベース設計](../requirements/12-データベース設計.md)
- [要件定義: API設計](../requirements/13-API設計.md)
- [要件定義: 画面遷移](../requirements/11-画面遷移.md)

